<html>
<head>
    <title>Super Awesome Threejs</title>
    <script src="js/three.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/physi.js"></script>
    <script src="fonts/helvetiker_bold.typeface.js"></script>
    <script src="fonts/helvetiker_regular.typeface.js"></script>

    <style>
        body, html {
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <script>
        Physijs.scripts.worker = 'js/physijs_worker.js';
        Physijs.scripts.ammo = 'ammo.js';
        
        var three = THREE;
        

        var scene = new Physijs.Scene();
        scene.setGravity(new THREE.Vector3(0, -30, 0));
        scene.addEventListener('update', update);

        var renderer = new three.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMapEnabled = true;
        renderer.shadowMapSoft = true;
        document.body.appendChild(renderer.domElement);

        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0, 50, 60);
        camera.lookAt(scene.position);

        // Materials
        ground_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ color: 0xff0000 }),
			.8, // high friction
			.4 // low restitution
		);

        ball_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ color: 0x00ff00 }),
			.4, // low friction
			.6 // high restitution
		);

        // Meshes
        var ground = new Physijs.BoxMesh(
			new THREE.BoxGeometry(100, 5, 20),
			ground_material,
			0 // mass
		);
        ground.receiveShadow = true;

        var ballBase = new Physijs.SphereMesh(
				new THREE.IcosahedronGeometry(5, 4),
				ball_material,
                1000
			);
        ballBase.position.set(0, 10, 0);
        ballBase.castShadow = true;

        var ballMid = new Physijs.SphereMesh(
				new THREE.IcosahedronGeometry(5, 4),
				ball_material,
                0.1
			);
        ballMid.position.set(5, 15, 0);
        ballMid.castShadow = true;

        var baseMidConstraint = new Physijs.ConeTwistConstraint(ballBase, ballMid, new THREE.Vector3(0, 15, 0));
        //baseMidConstraint.setLimit(5, 5, 5);

        //ball.scale.set(
        //    Math.random() * 1 + .5,
        //    Math.random() * 1 + .5,
        //    Math.random() * 1 + .5
        //);

        // Light
        var light = new THREE.DirectionalLight(0xFFFFFF);
        light.position.set(20, 40, -15);
        light.target.position.copy(scene.position);
        light.castShadow = true;
        light.shadowCameraLeft = -60;
        light.shadowCameraTop = -60;
        light.shadowCameraRight = 60;
        light.shadowCameraBottom = 60;
        light.shadowCameraNear = 20;
        light.shadowCameraFar = 200;
        light.shadowBias = -.0001
        light.shadowMapWidth = light.shadowMapHeight = 2048;
        light.shadowDarkness = .7;

        var ambient = new three.AmbientLight(0x111111);
        ambient.intensity = 0.1;

        scene.add(camera);
        scene.add(light);
        scene.add(ambient);
        scene.add(ground);
        scene.add(ballBase);
        scene.add(ballMid);

        scene.addConstraint(baseMidConstraint, true);

        var render_stats = new Stats();
        render_stats.domElement.style.position = 'absolute';
        render_stats.domElement.style.top = '1px';
        render_stats.domElement.style.zIndex = 100;
        document.body.appendChild(render_stats.domElement);

        var physics_stats = new Stats();
        physics_stats.domElement.style.position = 'absolute';
        physics_stats.domElement.style.top = '50px';
        physics_stats.domElement.style.zIndex = 100;
        document.body.appendChild(physics_stats.domElement);

        requestAnimationFrame(render);
        scene.simulate();

        //scene.add(skyMesh);
        //scene.add(mesh);

        //animate();

        //function animate() {
        //    mesh.rotateOnAxis((new three.Vector3(1, 1, 0)).normalize(), 0.003);

        //    skyMesh.rotateOnAxis((new three.Vector3(1, 1, 0)).normalize(), -0.1);

        //    renderer.render(scene, camera);

        //    requestAnimationFrame(animate);
        //}

        function update() {
            //applyForce();
            scene.simulate(undefined, 1);
            physics_stats.update();
        };


        function render() {
            requestAnimationFrame(render);
            renderer.render(scene, camera);
            render_stats.update();
        };

        function applyForce(){
            if (!mouse_position) return;
            var strength = 35, distance, effect, offset, box;

            for (var i = 0; i < boxes.length; i++) {
                box = boxes[i];
                distance = mouse_position.distanceTo(box.position),
                effect = mouse_position.clone().sub(box.position).normalize().multiplyScalar(strength / distance).negate(),
                offset = mouse_position.clone().sub(box.position);
                box.applyImpulse(effect, offset);
            }
        };

    </script>
</body>
</html>